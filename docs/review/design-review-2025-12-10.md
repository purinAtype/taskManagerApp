# 設計書レビューレポート

## レビュー情報
- レビュー日: 2025-12-10
- 対象: カテゴリー管理機能
- レビュアー: design-reviewer

## サマリー
| 設計書 | 差異件数 | ステータス |
|:---|:---|:---|
| 画面設計書 | 3件 | 要修正 |
| API設計書 | 6件 | 要修正 |
| モックアップ整合性 | 2件 | 要修正 |
| DB整合性 | 0件 | OK |

## 差異一覧

### 1. 画面設計書の差異

#### 1.1 SCR-CAT-001（カテゴリー一覧）

| No | 箇所 | 設計書の記載 | 実際の問題 | 対応 |
|:---|:---|:---|:---|:---|
| 1 | イベント仕様 - 削除ボタン | DELETE `/categories/{id}` | モックアップは POST `/categories/{id}/delete` を想定（line 196） | 設計書修正 |
| 2 | 削除失敗時のエラーメッセージ | 「このカテゴリーは使用中のため削除できません」 | API設計書には「このカテゴリーは使用中のため削除できません。紐づくタスクを先に削除または変更してください。」とより詳細 | 設計書修正 |

#### 1.2 SCR-CAT-002（カテゴリー新規登録）

| No | 箇所 | 設計書の記載 | 実際の問題 | 対応 |
|:---|:---|:---|:---|:---|
| 3 | バリデーション - color | `@Pattern(regexp="^#[0-9A-Fa-f]{6}$")` | API-CAT-003にも同じパターンがあり、エラーメッセージが「カラーコードの形式が不正です（例: #FF5733）」だが、画面設計書は「カラーコードは正しい形式で入力してください（例: #FF5733）」と微妙に異なる | 設計書修正（API設計書に統一） |

#### 1.3 SCR-CAT-003（カテゴリー編集）

| No | 箇所 | 設計書の記載 | 実際の問題 | 対応 |
|:---|:---|:---|:---|:---|
| 4 | 遷移先 - 更新成功時 | カテゴリー一覧 | API-CAT-004では `/categories/{id}`（詳細画面）へリダイレクトと記載 | 設計書修正（API設計書に合わせる） |
| 5 | HTTPメソッド - 更新ボタン | PUT `/categories/{id}` | API-CAT-004では POST `/categories/{id}` | 設計書修正 |

### 2. API設計書の差異

#### 2.1 API-CAT-002（カテゴリー詳細取得）

| No | 箇所 | 設計書の記載 | 実際の問題 | 対応 |
|:---|:---|:---|:---|:---|
| 6 | ビュー名 | `category/detail.html` | 画面一覧では詳細画面がなく、一覧画面から直接編集画面へ遷移する設計 | 設計書修正（不要なAPI） |

> **重要**: API-CAT-002は画面設計に存在しない詳細画面用のAPIです。現在の画面設計では以下の遷移になっています：
> - カテゴリー一覧（SCR-CAT-001）→ 編集画面（SCR-CAT-003）
> - カテゴリー一覧（SCR-CAT-001）→ 削除
>
> 詳細画面を追加するか、API-CAT-002を削除するか、どちらかの対応が必要です。

#### 2.2 API-CAT-004（カテゴリー更新）

| No | 箇所 | 設計書の記載 | 実際の問題 | 対応 |
|:---|:---|:---|:---|:---|
| 7 | リダイレクト先 | `/categories/{id}`（詳細画面） | 画面設計書SCR-CAT-003では一覧画面へリダイレクト | 設計書修正（画面設計書に合わせる） |
| 8 | バリデーションエラー時のビュー | `category/form.html` | 画面設計書では `category/edit.html` を使用 | 設計書修正 |

#### 2.3 API-CAT-003（カテゴリー作成）

| No | 箇所 | 設計書の記載 | 実際の問題 | 対応 |
|:---|:---|:---|:---|:---|
| 9 | color のバリデーション | `@NotBlank` | 画面設計書では必須だが、カラーピッカー（type="color"）は空白を送信しないため、実際には `@NotBlank` は不要。`@NotNull` で十分 | 確認事項 |

#### 2.4 API-CAT-005（カテゴリー削除）

| No | 箇所 | 設計書の記載 | 実際の問題 | 対応 |
|:---|:---|:---|:---|:---|
| 10 | 削除不可時のリダイレクト先 | `/categories/{id}`（詳細画面） | 画面設計書では詳細画面が存在しないため、一覧画面へリダイレクトすべき | 設計書修正 |
| 11 | 備考 - 外部キー制約の動作 | 「外部キー制約（ON DELETE SET NULL）により...」 | schema.sqlでは `ON DELETE SET NULL` が設定されているが、実際にはタスク使用チェックで削除を防ぐため、この動作は発生しない。記載が誤解を招く | 設計書修正 |

### 3. モックアップとの整合性

#### 3.1 07_category_list.html

| No | 箇所 | モックアップの実装 | 設計書の記載 | 対応 |
|:---|:---|:---|:---|:---|
| 12 | 削除フォームのaction | JavaScript で `/categories/${categoryId}` を設定（line 196） | 画面設計書は DELETE メソッド、API設計書は POST `/categories/{id}/delete` | 設計書修正（モックアップの実装に合わせる） |
| 13 | hidden フィールド | `<input type="hidden" name="_method" value="DELETE">` | Spring の HiddenHttpMethodFilter を使用する想定だが、API設計書は POST `/categories/{id}/delete` | 整合性確認が必要 |

### 4. DB定義との整合性

| No | 箇所 | 問題 | 対応 |
|:---|:---|:---|:---|
| - | 全項目 | OK | - |

> **確認**: task_categories テーブルの全カラムとデータ型、制約は画面・API設計書と完全に一致しています。

### 5. 命名規則・フォーマット

| No | 箇所 | 問題 | 対応 |
|:---|:---|:---|:---|
| - | 全ファイル | OK | - |

> **確認**: 画面ID（SCR-CAT-XXX）、API ID（API-CAT-XXX）、ファイル名はすべて命名規則に準拠しています。

## 修正推奨事項

### 優先度: 高（必須修正）

1. **API-CAT-002の扱い決定**
   - 現状: 詳細画面用のAPIが存在するが、画面設計に詳細画面がない
   - 選択肢A: 詳細画面（SCR-CAT-004）を追加し、API-CAT-002を活用する
   - 選択肢B: API-CAT-002を削除し、一覧→編集の直接遷移を維持する
   - **推奨**: 選択肢Bを推奨（シンプルな設計を維持）

2. **HTTPメソッドとエンドポイントの統一**
   - 削除API: POST `/categories/{id}/delete` に統一（モックアップに合わせる）
   - 更新API: POST `/categories/{id}` に統一（Spring MVC + Thymeleaf の標準的な実装）

3. **リダイレクト先の統一**
   - カテゴリー更新成功時: `/categories` (一覧画面) へリダイレクト
   - カテゴリー削除不可時: `/categories` (一覧画面) へリダイレクト

### 優先度: 中（推奨修正）

4. **エラーメッセージの統一**
   - バリデーションエラーメッセージを画面設計書とAPI設計書で完全に統一
   - 削除不可エラーメッセージを詳細化（API設計書の表現に統一）

5. **ビュー名の明確化**
   - 新規登録: `category/form.html`
   - 編集: `category/edit.html`
   - 一覧: `category/list.html`
   - API設計書で正しいビュー名を使用する

### 優先度: 低（確認事項）

6. **カラーピッカーのバリデーション**
   - `type="color"` の input 要素は常に有効な hex カラーコードを返すため、`@Pattern` によるバリデーションは実質不要
   - ただし、APIの直接呼び出しを想定する場合は必要
   - 現状のままでも問題ないが、コメントで理由を明記することを推奨

## 修正対応方針

### ステップ1: API-CAT-002の削除（推奨）
- API設計書 `API-CAT-002_カテゴリー詳細取得.md` を削除
- API一覧から API-CAT-002 の記載を削除

### ステップ2: 画面設計書の修正
- SCR-CAT-001: 削除APIを POST `/categories/{id}/delete` に修正
- SCR-CAT-003: 更新成功時のリダイレクト先を一覧画面に修正、HTTPメソッドを POST に修正

### ステップ3: API設計書の修正
- API-CAT-004: リダイレクト先を `/categories`、バリデーションエラー時のビューを `category/edit.html` に修正
- API-CAT-005: 削除不可時のリダイレクト先を `/categories` に修正、備考の外部キー制約の説明を修正

### ステップ4: バリデーションメッセージの統一
- 画面設計書とAPI設計書のエラーメッセージを完全一致させる

## 重要な設計判断

### 判断1: 詳細画面の省略
- **理由**: カテゴリー管理はシンプルな CRUD であり、詳細画面を省略して一覧→編集の直接遷移で十分
- **メリット**: 画面数の削減、ユーザー操作の簡略化
- **デメリット**: 読み取り専用の詳細表示ができない
- **結論**: 現在の設計（詳細画面なし）を維持することを推奨

### 判断2: 削除のHTTPメソッド
- **理由**: Thymeleaf + Spring MVC では POST + hidden `_method` または POST `/xxx/delete` が標準的
- **選択**: POST `/categories/{id}/delete` を採用（モックアップに合わせる）
- **代替案**: DELETE メソッドを使用する場合、JavaScript での fetch API 呼び出しが必要

## 次回以降の改善提案

1. **画面遷移図の更新**
   - カテゴリー管理機能の遷移を追加
   - 削除後の遷移フローを明確化

2. **エラーハンドリングの詳細化**
   - 外部キー制約エラー時の具体的な処理フローを設計書に記載
   - タスク使用中の削除不可のメッセージを画面でどう表示するか明確化

3. **テストケースの追加**
   - カテゴリー管理機能の E2E テストケースを作成
   - バリデーションの境界値テストケースを画面設計書にも記載

## 修正済み設計書

### 画面設計書
- [X] SCR-CAT-001_カテゴリー一覧.md
  - 削除APIのHTTPメソッドをPOST `/categories/{id}/delete` に修正
  - 削除失敗時のエラーメッセージを詳細化

- [X] SCR-CAT-002_カテゴリー新規登録.md
  - カラーコードバリデーションのエラーメッセージを統一

- [X] SCR-CAT-003_カテゴリー編集.md
  - 更新APIのHTTPメソッドをPOSTに修正
  - リダイレクト先を一覧画面に統一
  - カラーコードバリデーションのエラーメッセージを統一

### API設計書
- [X] API-CAT-004_カテゴリー更新.md
  - リダイレクト先を一覧画面に修正
  - バリデーションエラー時のビューを `category/edit.html` に修正
  - 処理ステップとテストケースを更新

- [X] API-CAT-005_カテゴリー削除.md
  - 削除不可時のリダイレクト先を一覧画面に修正
  - 外部キー制約の説明を明確化
  - エラーメッセージを詳細化

### その他
- [X] API一覧.md
  - カテゴリー管理APIの一覧を更新
  - API-CAT-002（旧:カテゴリー詳細取得）を削除
  - 新しいAPI体系に変更（API-CAT-002〜006を再定義）

## 未対応事項

### API設計書ファイルの作成が必要
以下のAPI設計書ファイルを新規作成する必要があります：

1. **API-CAT-002_カテゴリー登録フォーム表示.md**
   - GET `/categories/new`
   - SCR-CAT-002の初期表示処理に対応

2. **API-CAT-004_カテゴリー編集フォーム表示.md**
   - GET `/categories/{id}/edit`
   - SCR-CAT-003の初期表示処理に対応

### API設計書ファイルのリナンバリングが必要
既存ファイルの番号変更：
- 旧 `API-CAT-004_カテゴリー更新.md` → 新 `API-CAT-005_カテゴリー更新.md`
- 旧 `API-CAT-005_カテゴリー削除.md` → 新 `API-CAT-006_カテゴリー削除.md`

### 削除が必要なファイル
- `API-CAT-002_カテゴリー詳細取得.md`（詳細画面が存在しないため不要）

> **注記**: ファイルの削除・リネーム・新規作成は `api-designer` エージェントまたは手動で実施してください。

## 備考

- 本レビューは設計書間の整合性を確認したものであり、実装コードとの整合性は確認していません
- 実装後は `consistency-checker` による三者（モック・設計書・実装）整合性チェックを推奨します
- DB定義（schema.sql）との整合性は完全に確認されています

## 変更履歴

| バージョン | 日付 | 内容 |
|:---|:---|:---|
| 1.0.0 | 2025-12-10 | カテゴリー管理機能の初回レビュー |
