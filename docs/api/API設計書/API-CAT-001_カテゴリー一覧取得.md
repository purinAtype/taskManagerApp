# API設計書

> **出力先**: `docs/api/API設計書/`
> **ファイル名**: `API-CAT-001_カテゴリー一覧取得.md`

## 1. 文書情報

| 項目 | 内容 |
| :--- | :--- |
| **API ID** | API-CAT-001 |
| **API名** | カテゴリー一覧取得 |
| **カテゴリ** | カテゴリー管理 |
| **バージョン** | 1.0.0 |
| **作成日** | 2025-12-10 |
| **作成者** | API設計エージェント |
| **最終更新日** | 2025-12-10 |
| **最終更新者** | API設計エージェント |

---

## 2. API概要

| 項目 | 内容 |
| :--- | :--- |
| **エンドポイント** | `/categories` |
| **HTTPメソッド** | `GET` |
| **機能概要** | カテゴリー一覧を取得する。表示順（display_order）でソートされる。 |
| **処理種別** | `データ取得` |
| **トランザクション** | `なし` |
| **認証** | `不要` |
| **必要権限** | `なし` |

### 使用場面

- カテゴリー一覧画面の初期表示
- タスク登録・編集画面でのカテゴリー選択肢取得
- カテゴリー登録・編集・削除後の一覧画面への遷移

---

## 3. リクエスト仕様

### 3.1 パスパラメータ

なし

### 3.2 クエリパラメータ

なし

### 3.3 リクエストボディ

なし

### 3.4 バリデーションルール

なし（パラメータなし）

---

## 4. レスポンス仕様

### 4.1 正常時レスポンス

* **HTTPステータスコード**: `200 OK`
* **Content-Type**: `text/html` (Thymeleafテンプレート)

**レンダリングされるビュー**: `category/list.html`

**モデル属性**:

| 属性名 | 型 | 必須 | 説明 | 例 |
| :--- | :--- | :--- | :--- | :--- |
| `categories` | `List<CategoryDto>` | ✔ | カテゴリーDTOのリスト | - |
| `successMessage` | `String` | - | 成功メッセージ（フラッシュ属性） | `"カテゴリーを削除しました"` |

### 4.2 一覧取得時のレスポンス

**CategoryDto のフィールド定義**:

| フィールド名 | 型 | 必須 | 説明 | 例 |
| :--- | :--- | :--- | :--- | :--- |
| `id` | `Long` | ✔ | カテゴリーID | `1` |
| `name` | `String` | ✔ | カテゴリー名 | `"仕事"` |
| `description` | `String` | - | 説明 | `"仕事関連のタスク"` |
| `color` | `String` | ✔ | カラーコード | `"#007bff"` |
| `displayOrder` | `Integer` | ✔ | 表示順 | `1` |
| `taskCount` | `Integer` | ✔ | このカテゴリーに属するタスク数 | `5` |
| `createdAt` | `LocalDateTime` | ✔ | 作成日時 | `2025-01-15T10:30:00` |
| `updatedAt` | `LocalDateTime` | ✔ | 更新日時 | `2025-01-15T10:30:00` |

---

## 5. 処理詳細

### 5.1 処理ステップ

| ステップ | 処理内容 | 備考 |
| :--- | :--- | :--- |
| 1 | CategoryService.findAll() を呼び出し全件取得 | SQL1, SQL2 |
| 2 | 各カテゴリーに紐づくタスク数を取得 | SQL2でCOUNT集計 |
| 3 | モデルに取得データを設定 | - |
| 4 | ビュー `category/list.html` をレンダリング | - |

### 5.2 使用サービス

| サービスクラス | メソッド | 役割 |
| :--- | :--- | :--- |
| `CategoryService` | `findAll()` | 全カテゴリーをタスク数付きで取得 |

### 5.3 使用テーブル

| テーブル名 | 物理名 | 操作 | 用途 |
| :--- | :--- | :--- | :--- |
| カテゴリー | `task_categories` | `SELECT` | カテゴリー情報の取得 |
| タスク | `tasks` | `SELECT` | タスク数のカウント |

### 5.4 SQL詳細

#### SQL1: カテゴリー一覧取得（タスク数付き）

**目的**: 全カテゴリーを表示順でソートし、各カテゴリーに紐づくタスク数を集計して取得する

**Mapper**: `CategoryMapper.selectAllWithTaskCount`

```sql
SELECT
    c.id,
    c.name,
    c.description,
    c.color,
    c.display_order,
    c.created_at,
    c.updated_at,
    COUNT(t.id) AS task_count
FROM task_categories c
LEFT JOIN tasks t ON c.id = t.category_id
GROUP BY c.id, c.name, c.description, c.color, c.display_order, c.created_at, c.updated_at
ORDER BY c.display_order ASC
```

**パラメータ**: なし

**返却値**: カテゴリー情報とタスク数のリスト

---

## 6. ビジネスロジック

該当なし

---

## 7. トランザクション制御

該当なし（参照のみ）

---

## 8. エラーハンドリング

| エラー条件 | HTTPステータス | エラーコード | 処理内容 |
| :--- | :--- | :--- | :--- |
| DB接続エラー | 500 | INTERNAL_SERVER_ERROR | エラー画面表示、ログ出力 |

---

## 9. 外部連携

該当なし

---

## 10. 関連API

| API名 | エンドポイント | 関係性 |
| :--- | :--- | :--- |
| カテゴリー詳細取得 | `/categories/{id}` | 一覧からの詳細遷移 |
| カテゴリー作成フォーム表示 | `/categories/new` | 一覧からの新規登録遷移 |
| カテゴリー編集フォーム表示 | `/categories/{id}/edit` | 一覧からの編集遷移 |

---

## 11. テストケース

### 11.1 正常系

| No. | テストケース | 入力値 | 期待結果 |
| :--- | :--- | :--- | :--- |
| 1 | 全件取得 | なし | 200 OK、全カテゴリーをdisplay_order順で取得 |
| 2 | カテゴリー0件の場合 | 該当データなし | 200 OK、空リストを返却 |
| 3 | タスク数0のカテゴリー | タスクが紐づいていない | 200 OK、task_count=0で取得 |

### 11.2 異常系

| No. | テストケース | 入力値 | 期待結果 |
| :--- | :--- | :--- | :--- |
| 1 | DB接続エラー | - | 500 INTERNAL_SERVER_ERROR |

### 11.3 境界値

| No. | テストケース | 入力値 | 期待結果 |
| :--- | :--- | :--- | :--- |
| 1 | カテゴリー1件のみ | - | 200 OK、1件取得 |
| 2 | カテゴリー大量データ | 1000件以上 | 200 OK、全件取得 |

---

## 12. 備考

- タスク数はLEFT JOINとCOUNT集計で算出
- display_orderの昇順でソートされる
- タスクが紐づいていないカテゴリーもtask_count=0として表示
- MyBatisマッパーは `CategoryMapper` (カスタムマッパー) を使用

---

## 13. 変更履歴

| バージョン | 変更日 | 変更者 | 変更内容 |
| :--- | :--- | :--- | :--- |
| 1.0.0 | 2025-12-10 | API設計エージェント | 新規作成 |
