# API設計書

> **出力先**: `docs/api/API設計書/`
> **ファイル名**: `API-CAT-005_カテゴリー削除.md`

## 1. 文書情報

| 項目 | 内容 |
| :--- | :--- |
| **API ID** | API-CAT-005 |
| **API名** | カテゴリー削除 |
| **カテゴリ** | カテゴリー管理 |
| **バージョン** | 1.0.0 |
| **作成日** | 2025-12-10 |
| **作成者** | API設計エージェント |
| **最終更新日** | 2025-12-10 |
| **最終更新者** | API設計エージェント |

---

## 2. API概要

| 項目 | 内容 |
| :--- | :--- |
| **エンドポイント** | `/categories/{id}/delete` |
| **HTTPメソッド** | `POST` |
| **機能概要** | 指定されたIDのカテゴリーを削除する。削除前にタスクとの関連をチェックし、使用中の場合は削除不可とする。 |
| **処理種別** | `データ削除` |
| **トランザクション** | `あり` |
| **認証** | `不要` |
| **必要権限** | `なし` |

### 使用場面

- カテゴリー詳細画面での削除ボタン押下時
- カテゴリー一覧画面での削除ボタン押下時

---

## 3. リクエスト仕様

### 3.1 パスパラメータ

| 名前 | 型 | 必須 | 説明 | 例 |
| :--- | :--- | :--- | :--- | :--- |
| `id` | `Long` | ✔ | カテゴリーID | `1` |

### 3.2 クエリパラメータ

なし

### 3.3 リクエストボディ

なし（POSTメソッドだが、リクエストボディは不要）

### 3.4 バリデーションルール

| 項目 | バリデーション内容 | エラーメッセージ |
| :--- | :--- | :--- |
| `id` | 数値型であること | Spring が自動的にバインドエラーとして処理 |

---

## 4. レスポンス仕様

### 4.1 正常時レスポンス

* **HTTPステータスコード**: `302 Found` (リダイレクト)
* **リダイレクト先**: `/categories` (カテゴリー一覧画面)
* **フラッシュ属性**: `successMessage = "カテゴリーを削除しました"`

### 4.2 削除不可時レスポンス（使用中）

* **HTTPステータスコード**: `302 Found` (リダイレクト)
* **リダイレクト先**: `/categories` (カテゴリー一覧画面)
* **フラッシュ属性**: `errorMessage = "このカテゴリーは使用中のため削除できません。紐づくタスクを先に削除または変更してください。"`

---

## 5. 処理詳細

### 5.1 処理ステップ

| ステップ | 処理内容 | 備考 |
| :--- | :--- | :--- |
| 1 | パスパラメータから id を取得 | - |
| 2 | CategoryService.delete(id) を呼び出し | トランザクション開始 |
| 3 | CategoryService.findById(id) でカテゴリー存在確認（SQL1） | - |
| 4 | カテゴリーが存在しない場合、NotFoundException をスロー | 404エラー |
| 5 | TaskService.countByCategoryId(id) でタスク使用数を確認（SQL2） | - |
| 6 | タスク使用数 > 0 の場合、ステップ10へ | 削除不可 |
| 7 | CategoryMapper.delete(id) でカテゴリーを削除（SQL3） | - |
| 8 | トランザクションコミット | - |
| 9 | フラッシュ属性に成功メッセージを設定し、一覧画面へリダイレクト | 正常終了 |
| 10 | トランザクションロールバック | - |
| 11 | フラッシュ属性にエラーメッセージを設定し、一覧画面へリダイレクト | 削除不可終了 |

### 5.2 使用サービス

| サービスクラス | メソッド | 役割 |
| :--- | :--- | :--- |
| `CategoryService` | `delete(id)` | カテゴリーを削除（使用チェック含む） |
| `CategoryService` | `findById(id)` | カテゴリー存在確認 |
| `TaskService` | `countByCategoryId(categoryId)` | カテゴリーに紐づくタスク数をカウント |

### 5.3 使用テーブル

| テーブル名 | 物理名 | 操作 | 用途 |
| :--- | :--- | :--- | :--- |
| カテゴリー | `task_categories` | `SELECT` | カテゴリー存在確認 |
| タスク | `tasks` | `SELECT` | タスク使用数のカウント |
| カテゴリー | `task_categories` | `DELETE` | カテゴリー情報の削除 |

### 5.4 SQL詳細

#### SQL1: カテゴリー存在確認

**目的**: 指定されたIDのカテゴリーが存在するか確認する

**Mapper**: `CategoryMapper.selectById`

```sql
SELECT id, name, description, color, display_order, created_at, updated_at
FROM task_categories
WHERE id = #{id}
```

**パラメータ**:

| パラメータ名 | 型 | 説明 | 例 |
| :--- | :--- | :--- | :--- |
| `#{id}` | `Long` | カテゴリーID | `1` |

#### SQL2: タスク使用数カウント

**目的**: 指定されたカテゴリーIDに紐づくタスク数をカウントする

**Mapper**: `TaskMapper.countByCategoryId`

```sql
SELECT COUNT(*)
FROM tasks
WHERE category_id = #{categoryId}
```

**パラメータ**:

| パラメータ名 | 型 | 説明 | 例 |
| :--- | :--- | :--- | :--- |
| `#{categoryId}` | `Long` | カテゴリーID | `1` |

**返却値**: タスク数（Integer）

#### SQL3: カテゴリー削除

**目的**: 指定されたIDのカテゴリーを物理削除する

**Mapper**: `CategoryMapper.delete`

```sql
DELETE FROM task_categories
WHERE id = #{id}
```

**パラメータ**:

| パラメータ名 | 型 | 説明 | 例 |
| :--- | :--- | :--- | :--- |
| `#{id}` | `Long` | カテゴリーID | `1` |

---

## 6. ビジネスロジック

### 6.1 削除可否判定ロジック

**判定条件**:
- タスク使用数 = 0 の場合: 削除可能
- タスク使用数 > 0 の場合: 削除不可

**削除不可時の処理**:
1. トランザクションをロールバック
2. エラーメッセージをフラッシュ属性に設定
3. カテゴリー詳細画面へリダイレクト

---

## 7. トランザクション制御

| 項目 | 内容 |
| :--- | :--- |
| **トランザクション境界** | CategoryService.delete() メソッド全体 |
| **コミット条件** | カテゴリー削除SQL正常実行時 |
| **ロールバック条件** | SQL実行エラー、カテゴリー未存在時、タスク使用中 |
| **トランザクション管理** | Spring の @Transactional アノテーション |

---

## 8. エラーハンドリング

| エラー条件 | HTTPステータス | エラーコード | 処理内容 |
| :--- | :--- | :--- | :--- |
| カテゴリー未存在 | 404 | NOT_FOUND | 404エラー画面（SCR-CMN-001）を表示 |
| タスク使用中 | 302 | - | 一覧画面へリダイレクト、"このカテゴリーは使用中のため削除できません。紐づくタスクを先に削除または変更してください。"エラー表示 |
| 不正なID形式 | 400 | BAD_REQUEST | Spring が自動的にエラーレスポンスを返却 |
| DB接続エラー | 500 | INTERNAL_SERVER_ERROR | 500エラー画面（SCR-CMN-002）を表示、ログ出力 |

---

## 9. 外部連携

該当なし

---

## 10. 関連API

| API名 | エンドポイント | 関係性 |
| :--- | :--- | :--- |
| カテゴリー一覧取得 | `GET /categories` | 削除成功時・削除不可時のリダイレクト先 |

---

## 11. テストケース

### 11.1 正常系

| No. | テストケース | 入力値 | 期待結果 |
| :--- | :--- | :--- | :--- |
| 1 | タスク未使用カテゴリーの削除 | id=1（タスク0件） | 302リダイレクト、一覧画面へ遷移、成功メッセージ表示 |

### 11.2 異常系

| No. | テストケース | 入力値 | 期待結果 |
| :--- | :--- | :--- | :--- |
| 1 | 存在しないカテゴリー | id=99999 | 404 NOT_FOUND |
| 2 | タスク使用中のカテゴリー削除 | id=1（タスク5件） | 302リダイレクト、一覧画面へ遷移、"使用中のため削除できません。紐づくタスクを先に削除または変更してください。"エラー表示 |
| 3 | 不正なID形式 | id=abc | 400 BAD_REQUEST |

### 11.3 境界値

| No. | テストケース | 入力値 | 期待結果 |
| :--- | :--- | :--- | :--- |
| 1 | タスク数1件のカテゴリー削除 | id=1（タスク1件） | 302リダイレクト、一覧画面へ遷移、削除不可エラー表示 |
| 2 | ID=0 | id=0 | 404 NOT_FOUND（存在しないため） |
| 3 | ID最大値 | id=9223372036854775807 | 404 NOT_FOUND（存在しない場合） |

---

## 12. 備考

- 物理削除を実施（論理削除ではない）
- タスクが1件でも紐づいている場合は削除不可
- 削除不可時は一覧画面へリダイレクトし、エラーメッセージでユーザーに対応を促す
- schema.sql では外部キー制約（ON DELETE SET NULL）が設定されているが、アプリケーション側でタスク使用チェックを実施し、事前に削除を防ぐため、この制約は実質的に発動しない
- MyBatisマッパーは `CategoryMapper` と `TaskMapper` (カスタムマッパー) を使用

---

## 13. 変更履歴

| バージョン | 変更日 | 変更者 | 変更内容 |
| :--- | :--- | :--- | :--- |
| 1.0.0 | 2025-12-10 | API設計エージェント | 新規作成 |
