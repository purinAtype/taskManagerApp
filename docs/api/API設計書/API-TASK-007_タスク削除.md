# API設計書

> **出力先**: `docs/api/API設計書/`
> **ファイル名**: `API-TASK-007_タスク削除.md`

## 1. 文書情報

| 項目 | 内容 |
| :--- | :--- |
| **API ID** | API-TASK-007 |
| **API名** | タスク削除 |
| **カテゴリ** | タスク管理 |
| **バージョン** | 1.0.0 |
| **作成日** | 2025-12-09 |
| **作成者** | API設計エージェント |
| **最終更新日** | 2025-12-09 |
| **最終更新者** | API設計エージェント |

---

## 2. API概要

| 項目 | 内容 |
| :--- | :--- |
| **エンドポイント** | `/tasks/{id}/delete` |
| **HTTPメソッド** | `POST` |
| **機能概要** | 指定されたIDのタスクをデータベースから物理削除する。削除成功後、タスク一覧画面へリダイレクトする。 |
| **処理種別** | `データ削除` |
| **トランザクション** | `あり` |
| **認証** | `不要` |
| **必要権限** | `なし` |

### 使用場面

- タスク詳細画面（SCR-TASK-003）での削除モーダル内「削除」ボタン押下時

---

## 3. リクエスト仕様

### 3.1 パスパラメータ

| 名前 | 型 | 必須 | 説明 | 例 |
| :--- | :--- | :--- | :--- | :--- |
| `id` | `Long` | ✔ | 削除対象のタスクID | `1` |

### 3.2 クエリパラメータ

なし

### 3.3 リクエストボディ

なし（フォーム送信だがボディパラメータなし）

### 3.4 バリデーションルール

| 項目 | バリデーション内容 | エラーメッセージ |
| :--- | :--- | :--- |
| `id` | 数値型であること | Spring が自動的にバインドエラーとして処理 |

---

## 4. レスポンス仕様

### 4.1 正常時レスポンス

* **HTTPステータスコード**: `302 Found` (リダイレクト)
* **リダイレクト先**: `/tasks` (タスク一覧画面)
* **フラッシュ属性**: `successMessage = "タスクを削除しました"`

---

## 5. 処理詳細

### 5.1 処理ステップ

| ステップ | 処理内容 | 備考 |
| :--- | :--- | :--- |
| 1 | パスパラメータから `id` を取得 | - |
| 2 | TaskService.delete(id) を呼び出し | トランザクション開始 |
| 3 | TaskService.findById(id) で削除対象の存在確認（SQL1） | - |
| 4 | タスクが存在しない場合、TaskNotFoundExceptionをスロー | ステップ7へ |
| 5 | TaskMapper.deleteById(id) でデータベースから削除（SQL2） | トランザクションコミット |
| 6 | フラッシュ属性に成功メッセージを設定し、一覧画面へリダイレクト | 正常終了 |
| 7 | GlobalExceptionHandler が例外を捕捉し、404エラー画面へ遷移 | エラー終了 |

### 5.2 使用サービス

| サービスクラス | メソッド | 役割 |
| :--- | :--- | :--- |
| `TaskService` | `delete(id)` | タスクを削除 |
| `TaskService` | `findById(id)` | 削除対象タスクの存在確認 |

### 5.3 使用テーブル

| テーブル名 | 物理名 | 操作 | 用途 |
| :--- | :--- | :--- | :--- |
| タスク | `tasks` | `SELECT` | 削除対象タスクの存在確認 |
| タスク | `tasks` | `DELETE` | タスク情報の物理削除 |

### 5.4 SQL詳細

#### SQL1: ID検索（存在確認）

**目的**: 削除対象のタスクが存在するか確認する

**Mapper**: `TaskMapper.selectByIdWithCategory`

```sql
SELECT
    t.id,
    t.title,
    t.description,
    t.status,
    t.priority,
    t.category_id,
    c.name AS category_name,
    c.color AS category_color,
    t.due_date,
    t.created_at,
    t.updated_at
FROM tasks t
LEFT JOIN task_categories c ON t.category_id = c.id
WHERE t.id = #{id}
```

**パラメータ**:

| パラメータ名 | 型 | 説明 | 例 |
| :--- | :--- | :--- | :--- |
| `#{id}` | `Long` | タスクID | `1` |

#### SQL2: タスク削除

**目的**: タスクをデータベースから物理削除する

**Mapper**: `TaskMapper.deleteById`

```sql
DELETE FROM tasks
WHERE id = #{id}
```

**パラメータ**:

| パラメータ名 | 型 | 説明 | 例 |
| :--- | :--- | :--- | :--- |
| `#{id}` | `Long` | タスクID | `1` |

---

## 6. ビジネスロジック

### 6.1 削除方式

- **物理削除**: レコード自体をデータベースから完全に削除する
- **論理削除は採用していない**: 削除フラグ等は使用せず、データを完全に消去する

---

## 7. トランザクション制御

| 項目 | 内容 |
| :--- | :--- |
| **トランザクション境界** | TaskService.delete() メソッド全体 |
| **コミット条件** | タスク削除SQL正常実行時 |
| **ロールバック条件** | SQL実行エラー、タスク未存在時 |
| **トランザクション管理** | Spring の @Transactional アノテーション |

---

## 8. エラーハンドリング

| エラー条件 | HTTPステータス | エラーコード | 処理内容 |
| :--- | :--- | :--- | :--- |
| タスク未存在 | 404 | NOT_FOUND | 404エラー画面（SCR-CMN-001）を表示 |
| 不正なID形式 | 400 | BAD_REQUEST | Spring が自動的にエラーレスポンスを返却 |
| DB接続エラー | 500 | INTERNAL_SERVER_ERROR | 500エラー画面（SCR-CMN-002）を表示、ログ出力 |

---

## 9. 外部連携

該当なし

---

## 10. 関連API

| API名 | エンドポイント | 関係性 |
| :--- | :--- | :--- |
| タスク詳細取得 | `GET /tasks/{id}` | 削除元画面 |
| タスク一覧取得 | `GET /tasks` | 削除成功時のリダイレクト先 |

---

## 11. テストケース

### 11.1 正常系

| No. | テストケース | 入力値 | 期待結果 |
| :--- | :--- | :--- | :--- |
| 1 | 存在するタスクを削除 | `id=1` | 302リダイレクト、成功メッセージ表示、DBからレコード削除 |
| 2 | カテゴリー設定済みタスクを削除 | `id=2` (category_id=1) | 302リダイレクト、正常削除（外部キー制約なし） |

### 11.2 異常系

| No. | テストケース | 入力値 | 期待結果 |
| :--- | :--- | :--- | :--- |
| 1 | 存在しないタスクIDで削除 | `id=99999` | 404 NOT_FOUND、エラー画面表示 |
| 2 | 不正なID形式 | `id=abc` | 400 BAD_REQUEST |
| 3 | 負の数のID | `id=-1` | 404 NOT_FOUND（該当データなし） |

### 11.3 境界値

| No. | テストケース | 入力値 | 期待結果 |
| :--- | :--- | :--- | :--- |
| 1 | ID=0 | `id=0` | 404 NOT_FOUND |
| 2 | ID最大値 | `id=9223372036854775807` | 404 NOT_FOUND（存在しない場合） |

---

## 12. 備考

- 削除は物理削除（レコード自体を削除）
- 削除前に必ずタスクの存在確認を実施
- カテゴリーとの外部キー制約は `ON DELETE SET NULL` のため、カテゴリーが削除されてもタスクは残る（逆は問題なし）
- 削除後は一覧画面へリダイレクトし、成功メッセージを表示
- MyBatisマッパーは `TaskMapper` (カスタムマッパー) を使用

---

## 13. 変更履歴

| バージョン | 変更日 | 変更者 | 変更内容 |
| :--- | :--- | :--- | :--- |
| 1.0.0 | 2025-12-09 | API設計エージェント | 新規作成 |
