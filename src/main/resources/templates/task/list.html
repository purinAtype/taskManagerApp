<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head('タスク一覧 - Task Manager')}"></head>
<body class="bg-light">
<header th:replace="~{fragments/layout :: header}"></header>

<main class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="bi bi-list-task me-2"></i>タスク一覧
        </h1>
        <a th:href="@{/tasks/new}" class="btn btn-primary">
            <i class="bi bi-plus-lg me-1"></i>新規タスク
        </a>
    </div>

    <!-- 成功メッセージ -->
    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle me-2"></i><span th:text="${successMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- フィルター -->
    <div class="card mb-4">
        <div class="card-body">
            <form th:action="@{/tasks}" method="get" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="status" class="form-label">ステータス</label>
                    <select class="form-select" id="status" name="status">
                        <option value="">すべて</option>
                        <option th:each="s : ${statuses}" th:value="${s}" th:text="${s.displayName}"
                                th:selected="${selectedStatus == s}"></option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="priority" class="form-label">優先度</label>
                    <select class="form-select" id="priority" name="priority">
                        <option value="">すべて</option>
                        <option th:each="p : ${priorities}" th:value="${p}" th:text="${p.displayName}"
                                th:selected="${selectedPriority == p}"></option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="categoryId" class="form-label">カテゴリー</label>
                    <select class="form-select" id="categoryId" name="categoryId">
                        <option value="">すべて</option>
                        <option th:each="c : ${categories}" th:value="${c.id}" th:text="${c.name}"
                                th:selected="${selectedCategoryId == c.id}"></option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-outline-secondary">
                        <i class="bi bi-search me-1"></i>検索
                    </button>
                    <a th:href="@{/tasks}" class="btn btn-outline-secondary">
                        <i class="bi bi-x-lg me-1"></i>クリア
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- タスク一覧テーブル -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th scope="col" style="width: 30%;">タイトル</th>
                            <th scope="col" style="width: 12%;">ステータス</th>
                            <th scope="col" style="width: 10%;">優先度</th>
                            <th scope="col" style="width: 13%;">カテゴリー</th>
                            <th scope="col" style="width: 15%;">期限</th>
                            <th scope="col" style="width: 20%;">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:if="${#lists.isEmpty(tasks)}">
                            <td colspan="6" class="text-center text-muted py-4">タスクがありません</td>
                        </tr>
                        <tr th:each="task : ${tasks}">
                            <td>
                                <a th:href="@{/tasks/{id}(id=${task.id})}" th:text="${task.title}"
                                   class="text-decoration-none fw-medium"></a>
                            </td>
                            <td>
                                <span class="badge"
                                      th:classappend="${task.status.name() == 'TODO'} ? 'bg-secondary' : (${task.status.name() == 'IN_PROGRESS'} ? 'bg-primary' : 'bg-success')"
                                      th:text="${task.statusDisplayName}"></span>
                            </td>
                            <td>
                                <span class="badge"
                                      th:classappend="${task.priority.name() == 'LOW'} ? 'bg-info' : (${task.priority.name() == 'MEDIUM'} ? 'bg-warning text-dark' : 'bg-danger')"
                                      th:text="${task.priorityDisplayName}"></span>
                            </td>
                            <td>
                                <span th:if="${task.categoryName != null}" class="badge"
                                      th:style="'background-color: ' + ${task.categoryColor} + ';'"
                                      th:text="${task.categoryName}"></span>
                                <span th:unless="${task.categoryName != null}" class="text-muted">-</span>
                            </td>
                            <td th:text="${task.dueDate != null} ? ${#temporals.format(task.dueDate, 'yyyy/MM/dd')} : '-'"></td>
                            <td>
                                <a th:href="@{/tasks/{id}(id=${task.id})}" class="btn btn-sm btn-outline-primary" title="詳細">
                                    <i class="bi bi-eye"></i>
                                </a>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer bg-white">
            <small class="text-muted">全 <span th:text="${#lists.size(tasks)}">0</span> 件</small>
        </div>
    </div>
</main>

<th:block th:replace="~{fragments/layout :: footer}"></th:block>
</body>
</html>
